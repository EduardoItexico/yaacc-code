# Vagrantfile for setup a yaacc development box
# -*- mode: ruby -*-
# vi: set ft=ruby :
def motdTemplate
        motdTemplate =                 "__/\\\\\\________/\\\\\\_____/\\\\\\\\\\\\\\\\\\________/\\\\\\\\\\\\\\\\\\___________/\\\\\\\\\\\\\\\\\\________/\\\\\\\\\\\\\\\\\\_        \n"
    motdTemplate =  motdTemplate + " _\\///\\\\\\____/\\\\\\/____/\\\\\\\\\\\\\\\\\\\\\\\\\\____/\\\\\\\\\\\\\\\\\\\\\\\\\\______/\\\\\\////////______/\\\\\\////////__       \n"
    motdTemplate =  motdTemplate + "  ___\\///\\\\\\/\\\\\\/_____/\\\\\\/////////\\\\\\__/\\\\\\/////////\\\\\\___/\\\\\\/_____________/\\\\\\/___________      \n"
    motdTemplate =  motdTemplate + "   _____\\///\\\\\\/______\\/\\\\\\_______\\/\\\\\\_\\/\\\\\\_______\\/\\\\\\__/\\\\\\______________/\\\\\\_____________     \n"
    motdTemplate =  motdTemplate + "    _______\\/\\\\\\_______\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_\\/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\_\\/\\\\\\_____________\\/\\\\\\_____________    \n"
    motdTemplate =  motdTemplate + "     _______\\/\\\\\\_______\\/\\\\\\/////////\\\\\\_\\/\\\\\\/////////\\\\\\_\\//\\\\\\____________\\//\\\\\\____________   \n"
    motdTemplate =  motdTemplate + "      _______\\/\\\\\\_______\\/\\\\\\_______\\/\\\\\\_\\/\\\\\\_______\\/\\\\\\__\\///\\\\\\___________\\///\\\\\\__________  \n"
    motdTemplate =  motdTemplate + "       _______\\/\\\\\\_______\\/\\\\\\_______\\/\\\\\\_\\/\\\\\\_______\\/\\\\\\____\\////\\\\\\\\\\\\\\\\\\____\\////\\\\\\\\\\\\\\\\\\_ \n"
    motdTemplate =  motdTemplate + "        _______\\///________\\///________\\///__\\///________\\///________\\/////////________\\/////////__\n"
    motdTemplate =  motdTemplate + "\n"
    motdTemplate =  motdTemplate + "\n"
    motdTemplate =  motdTemplate + "Welcome to YAACC - vagrant development box\n"

  return motdTemplate
end 

def configTemplate
	configTemplate=		      "######################################################\n"        
        configTemplate=configTemplate+"##  Yaacc - Vagrant - Configurationfile             ##\n"
        configTemplate=configTemplate+"##                                                  ##\n"       
        configTemplate=configTemplate+"######################################################\n"
        configTemplate=configTemplate+"######################################################\n"
        configTemplate=configTemplate+"##             Developer setup                      ##\n"
        configTemplate=configTemplate+"######################################################\n"
        configTemplate=configTemplate+"developerName=\"YOURNAME\"\n"
        configTemplate=configTemplate+"developerPrivateRSAKeyName=\"id_rsa\"\n"
        configTemplate=configTemplate+"developerPublicRSAKeyName=\"id_rsa.pub\"\n"
        configTemplate=configTemplate+"######################################################\n"
        configTemplate=configTemplate+"##            Yaacc - Keystore secrets              ##\n"
        configTemplate=configTemplate+"######################################################\n"
        configTemplate=configTemplate+"keypass=\"mySuperSecretPassword\"\n"
        configTemplate=configTemplate+"keystorepass=\"mySuperSecretPassword\"\n"
        configTemplate=configTemplate+"repokeyalias=\"yaacc\"\n"
        configTemplate=configTemplate+"keystoreName=\"yaacc.de-release-key.keystore\"\n"
        configTemplate=configTemplate+"###################################################\n"
        configTemplate=configTemplate+"##            Yaacc - GitRepo                    ##\n"
        configTemplate=configTemplate+"###################################################\n"
        configTemplate=configTemplate+"yaaccRepo=\"ssh://YOURNAME@git.code.sf.net/p/yaacc/code\"\n"
        configTemplate=configTemplate+"###################################################\n"
        configTemplate=configTemplate+"##            Froid                              ##\n"
        configTemplate=configTemplate+"###################################################\n"
        configTemplate=configTemplate+"fdroidServerRepo=\"git://gitorious.org/f-droid/fdroidserver.git\"\n"
        configTemplate=configTemplate+"fdroidDataRepo=\"git://gitorious.org/f-droid/YOURNAME-fdroiddata.git\"\n"
	return configTemplate
end


yaaccSecretPath="/home/" +ENV['USER']+ "/yaacc-secret"

if ! File.exist?("bootstrap.sh") || ! File.exist?(yaaccSecretPath) 
  puts "################################################################\n"
  puts "##  Y A A C C - D E V E L O P M E N T - B O X    S E T U P    ##\n"
  puts "################################################################\n"
end 

if ! File.exist?("bootstrap.sh")
  puts "Download box configuration file bootstrap.sh "
  system("wget https://sourceforge.net/p/yaacc/code/ci/release1.1/tree/vagrant/bootstrap.sh?format=raw -O bootstrap.sh")
end

if ! File.exist?(yaaccSecretPath)  
  puts "Yaacc secret folder not found seems to be the first start...\n"
  puts "Create secret path at '" + yaaccSecretPath + "'\n"
  Dir::mkdir(yaaccSecretPath)
  puts "Create sample config file in secret folder: '" + yaaccSecretPath + "/config'\n"
  f = File.new(yaaccSecretPath + "/config", "w")
  configTemplate.each_line{
    |line|
    f.write line
  }
  
  puts "Before restart vagrant setup your secrets:\n"
  puts "1) copy the yaacc debug keystore file into the secret folder"
  puts "2) copy the yaacc release keystore file into the secret folder.\n"
  puts "3) copy your private and public rsa key used for the authentication at fdroid repo  and yaacc repo into the secret folder\n"    
  puts "4) modifiy the config file '" + yaaccSecretPath + "/config'"
  puts "5) Restart vagrant..."
  exit
else
  puts "Found yaacc secret folder '" + yaaccSecretPath + "'. Now starting vagrant box ..."   
end



Vagrant::Config.run do |config|
 config.vm.box = "yaacc-dev" 
 config.vm.box_url = "http://files.vagrantup.com/precise32.box"
 config.vm.share_folder "yaacc-secret", "/mnt/yaacc-secret/" , yaaccSecretPath , :create => false
 config.vm.provision :shell, :inline => "echo '" + motdTemplate + "' > /etc/motd.tail"
 config.vm.provision :shell, :path => "bootstrap.sh"

end


